ARG BASE_IMAGE=debian:buster-slim
FROM $BASE_IMAGE as base

ARG DEBIAN_FRONTEND=noninteractive

#
# System-level installs
#

RUN apt-get update -y \
 && apt-get install -y --no-install-recommends \
      apt-utils \
      git \
      autoconf \
      libtool \
      cmake \
      build-essential \
      python3-minimal \
      python3-pip \
      python3-venv \
      python3-dev \
      libopenblas-dev \
      flex \
      bison \
      curl \
 && pip3 install --no-cache-dir --upgrade pip setuptools

#
# Add in atom source. This is OK since we'll be
#     removing it in the production container. Need
#     to re-initialize the submodules since they're
#     now in a container
#
ADD . /atom
WORKDIR /atom
RUN git submodule deinit -f . && git submodule update --init --recursive

#
# C client
#

# Build third-party C dependencies
RUN cd /atom/languages/c/third-party && make

# Build the C library
RUN cd /atom/languages/c \
 && make clean && make -j16 && make install

#
# C++ client
#

# Build and install the c++ library
RUN cd /atom/languages/cpp \
 && make clean && make -j16 && make install

#
# Python client
#

# Create and activate python virtualenv
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Install custom third-party deps. We need to build
# some of these separately as opposed to installing
# from pip
#
# Install list:
#   1. redis-py (needs support for memoryviews)
#   2. Cython (needs to be x-compiled for aarch64)
#   3. numpy (needs to be x-compiled for aarch64)
#   4. pyarrow (needs to be x-compiled for aarch64)

# Redis-py
RUN cd /atom/languages/python/third-party/redis-py \
 && python3 setup.py install

# Cython
WORKDIR /atom/languages/python/third-party/cython
RUN python3 setup.py build -j16 install

# Numpy
WORKDIR /atom/languages/python/third-party/numpy
RUN python3 setup.py build -j16 install

# Pyarrow
WORKDIR /atom/third-party/apache-arrow/python
RUN apt-get install -y pkg-config
RUN mkdir -p /atom/third-party/apache-arrow/cpp/build \
  && cd /atom/third-party/apache-arrow/cpp/build \
  && cmake -DCMAKE_BUILD_TYPE=release \
           -DOPENSSL_ROOT_DIR=/usr/local/ssl \
           -DCMAKE_INSTALL_LIBDIR=lib \
           -DCMAKE_INSTALL_PREFIX=/usr/local \
           -DARROW_PARQUET=ON \
           -DARROW_PYTHON=ON \
           -DARROW_PLASMA=ON \
           -DARROW_BUILD_TESTS=OFF \
           -DPYTHON_EXECUTABLE=/opt/venv/bin/python3 \
           .. \
  && make -j16 \
  && make install
RUN cd /atom/third-party/apache-arrow/python \
  && python3 setup.py build_ext -j 16 --build-type=release --with-parquet \
  && python3 setup.py install

# Build and install the python library
# Add and install requirements first to use DLC
ADD ./languages/python/requirements.txt /atom/languages/python/requirements.txt
RUN pip3 install --no-cache-dir -r /atom/languages/python/requirements.txt
ADD ./utilities/atom-cli/requirements.txt /atom/utilities/atom-cli/requirements.txt
RUN pip3 install --no-cache-dir -r /atom/utilities/atom-cli/requirements.txt

# Install atom-cli
ADD ./utilities/atom-cli /atom/utilities/atom-cli
RUN cp /atom/utilities/atom-cli/atom-cli.py /usr/local/bin/atom-cli \
 && chmod +x /usr/local/bin/atom-cli

ADD ./lua-scripts /atom/lua-scripts
RUN cd /atom/languages/python \
 && python3 setup.py install

# Change working directory back to atom location
WORKDIR /atom

FROM $BASE_IMAGE as prod

# Cache buster env var - change date to invalidate subsequent caching
# See the atom README "Atom Dockerfile" section for more information
ENV LAST_UPDATED 2019-03-06

# Install python
RUN apt-get update -y \
 && apt-get install -y --no-install-recommends apt-utils \
                                               python3-minimal \
                                               python3-pip

# Copy contents of python virtualenv and activate
COPY --from=base /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy C builds
COPY --from=base /usr/local/lib /usr/local/lib
COPY --from=base /usr/local/include /usr/local/include

# Copy atom-cli
COPY --from=base /usr/local/bin/atom-cli /usr/local/bin/atom-cli

# Add .circleci for docs build
ADD ./.circleci /atom/.circleci

# Change working directory back to atom location
WORKDIR /atom




FROM prod as test

ARG DEBIAN_FRONTEND=noninteractive

#
# Install test dependencies
#

# Cache buster env var - change date to invalidate subsequent caching
# See the atom README "Atom Dockerfile" section for more information
ENV LAST_UPDATED 2019-03-12

# Install googletest
RUN apt-get update \
 && apt-get install -y --no-install-recommends libgtest-dev cmake build-essential \
 && cd /usr/src/gtest \
 && cmake CMakeLists.txt && make -j16 && cp *.a /usr/lib

# Install valgrind
RUN apt-get install -y --no-install-recommends valgrind

# Install pytest
RUN pip3 install --no-cache-dir pytest

# Copy source code
COPY ./languages/c/ /atom/languages/c
COPY ./languages/cpp/ /atom/languages/cpp
COPY ./languages/python/tests /atom/languages/python/tests




FROM prod as graphics

ARG DEBIAN_FRONTEND=noninteractive

# Add in noVNC to /opt/noVNC
ADD third-party/noVNC /opt/noVNC

# Install graphics
# Note: supervisor-stdout must be installed with pip2 and not pip3
RUN apt-get install -y --no-install-recommends \
      libgl1-mesa-dri \
      menu \
      net-tools \
      openbox \
      supervisor \
      tint2 \
      x11-xserver-utils \
      x11vnc \
      xinit \
      xserver-xorg-video-dummy \
      xserver-xorg-input-void \
      websockify \
      git \
      sudo \
      python-pip \
 && rm -f /usr/share/applications/x11vnc.desktop \
# VNC
 && cd /opt/noVNC \
 && ln -s vnc_auto.html index.html \
 && pip2 install --no-cache-dir setuptools \
 && pip2 install --no-cache-dir supervisor-stdout \
 && apt-get -y remove python-pip git \
 && apt-get -y autoremove \
 && apt-get -y clean \
 && rm -rf /var/lib/apt/lists/*

# noVNC (http server) is on 6080, and the VNC server is on 5900
EXPOSE 6080 5900
COPY third-party/docker-opengl/etc/skel/.xinitrc /etc/skel/.xinitrc

RUN useradd -m -s /bin/bash user
USER user
RUN cp /etc/skel/.xinitrc /home/user/
USER root
RUN echo "user ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/user

COPY third-party/docker-opengl/etc /etc
COPY third-party/docker-opengl/usr /usr

# Need to run app with python2 instead of python3
RUN var='#!/usr/bin/env python2' \
 && sed -i "1s@.*@${var}@" /usr/bin/graphical-app-launcher.py

ENV DISPLAY :0
